<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="a_1.mapper.OrdersMapper">

    <!--根据订单ID查询订单以及用户信息-->
    <select id="findOrdersExt" parameterType="OrdersExt" resultType="OrdersExt">
        select o.id,
        o.user_id,
        o.number,
        o.createtime,
        o.note,
        u.username,u.address
        from orders o,user_info u
        where o.user_id = u.id
        <if test="id != null">
            and o.user_id = #{id}
        </if>
    </select>

    <!--根据订单ID查询订单以及用户信息by-resulrMap-->
    <select id="findOrdersByResultMap" parameterType="OrdersExt" resultMap="orderAndUserRstMap">
        select * from orders o,user_info u where o.user_id = u.id and u.id = #{id}
    </select>
    <resultMap id="orderAndUserRstMap" type="OrdersExt">
        <id column="id" property="id"/>
        <result column="username" property="username"/>
        <result column="address" property="address"/>
<!--        <result column="number" property="number"/>-->
<!--        <result column="note" property="note"/>-->
        <!--association: 一对一映射关联标签
            1.property属性:关联属性名
            2.javaType属性:属性对应的类型
            3.id标签在关键查询写上，提升查询性能
          -->
        <association property="user" javaType="User">
            <id column="user_id" property="id"/>
            <result column="username" property="username"/>
            <result column="address" property="address"/>
        </association>
    </resultMap>

    <!--一对多映射-->
    <select id="findOrdersAndOrderDetail" parameterType="OrdersExt" resultMap="orderAndOrderDetailRstMap">
        select o.id,
        o.user_id,
        o.number,
        o.createtime,
        o.note,
        u.username,
        u.address,
        od.id detailId,
        od.items_id,
        od.items_num
        from orders o,user_info u,orderdetail od
        where o.user_id = u.id
        and o.id = od.items_id
        <if test="id != null">
            and o.id = #{id}
        </if>
    </select>
    <!--通过extends继承其他resultMap，注意这两个resultMap的类型要一致-->
    <resultMap id="orderAndOrderDetailRstMap" type="OrdersExt" extends="orderAndUserRstMap">
    <!--订单明细信息 一对多-->
    <!--
        collection：映射一对多的关系
        property：一对多关联时的属性名
        ofType：关联的类型
      -->
    <collection property="orderDetails" ofType="OrderDetail">
        <id column="detailId" property="id"/>
        <result column="items_id" property="itemsId"/>
        <result column="items_num" property="itemsNum"/>
    </collection>
    </resultMap>

    <!--延迟加载-->
    <select id="findOrderInfoByLazyLoad" parameterType="integer" resultMap="lazyLoadRstMap">
        select * from orders where id = #{id}
    </select>
    <resultMap id="lazyLoadRstMap" type="OrdersExt">
        <!--订单配置信息映射-->
        <id column="id" property="id"/>
        <result column="number" property="number"/>
        <result column="note" property="note"/>
        <!--一对一用户信息映射
            association:具有懒加载功能
            select:通过select属性指定statement,其值是statement的id
            column: 指定查询结果的列，并且把该列的值作为传入参数，传入对应的statement中
            property: 关联查询时映射的属性
          -->
        <association property="user" select="a_1.mapper.UserMapper.findUserById" column="user_id"/>
    </resultMap>
</mapper>